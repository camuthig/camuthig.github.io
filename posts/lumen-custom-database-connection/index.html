<!DOCTYPE html>
<html lang="en-us">
    <head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
		<title>
				Creating Custom Database Connections in Lumen &middot; Chris Muthig
		</title>
	
		
  		<link rel="stylesheet" href="/css/style.css">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">
		<link rel="stylesheet" href="/css/custom.css">
		<link rel="stylesheet" href="/css/syntax.css">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,400i,700">
		
		<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
	
		
		<link href="" rel="alternate" type="application/rss+xml" title="Chris Muthig" />
	</head>
	
    <body>
        <nav class="navbar">
	<ul class="main-nav">
		<li>
			<a class="nav-links" href="/">Posts</a>
		</li>
		<li>
			<a class="nav-links" href="/about">About</a>
		</li>

	</ul>
</nav>

        

<main>
	<div class="post">
		<div class="post-info">
    <span>Written by</span>
        Chris Muthig
        <br>
        <span>on&nbsp;</span><time datetime="2019-04-17 00:00:00 &#43;0000 UTC">April 17, 2019</time>
</div>
		<h1 class="post-title">Creating Custom Database Connections in Lumen</h1>

<div class="tags-container">

    <div class="tag">
        <a class="tag-link" href="https://camuthig.dev/tags/php">php</a>
    </div>

    <div class="tag">
        <a class="tag-link" href="https://camuthig.dev/tags/laravel">laravel</a>
    </div>

    <div class="tag">
        <a class="tag-link" href="https://camuthig.dev/tags/lumen">lumen</a>
    </div>

</div>



		

		<p>A friend recently came to me with a question on how to create a database connection in Lumen without
using using external services to define the configuration values of the connection. I made some suggestions,
but it was an interesting quesiton so I decided to try tackling a <a href="https://github.com/camuthig/lumen-custom-db-connection">sample myself as well</a>.</p>

<p>I am not suggesting that the pattern described below for retrieving configuration values is a good idea. However,
sometimes as developers we are required to work within certain constraints we cannot control. That is just part
of the job, and it is important to be able to accomplish our work all the same.</p>

<p>Based on other architectural decisions, my friend&rsquo;s team had two different patterns for retrieving configuration values.
The first was that most configuration values, things like connection URLs for a database that might commonly be in a
<code>.env</code> or in environment variables, were stored in Redis to allow many applications to share the same values. The
second constraint was that credentials, like the username and password for connecting to a database, were stored
within an external service that could be accessed via HTTP. So the goal is to create our database connection using
a combination of these two services. In my example I will use Redis as the store for both services because
I don&rsquo;t want to take the time to implement a second HTTP service. However, the same encapsulations can be used.</p>

<p>The first step is to implement simple services that allow for setting and retrieving our two types of configuration
values.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">// https://github.com/camuthig/lumen-custom-db-connection/blob/master/app/Services/DistributedConfiguration.php
<span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">App\Services</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Predis\ClientInterface</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">DistributedConfiguration</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">get</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$config</span><span class="p">,</span> <span class="nv">$default</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="sd">/** @var ClientInterface $redis */</span>
        <span class="nv">$redis</span> <span class="o">=</span> <span class="nx">app</span><span class="p">(</span><span class="s1">&#39;redis&#39;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$redis</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nv">$config</span><span class="p">)</span> <span class="o">??</span> <span class="nv">$default</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">set</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$config</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
    <span class="p">{</span>
        <span class="sd">/** @var ClientInterface $redis */</span>
        <span class="nv">$redis</span> <span class="o">=</span> <span class="nx">app</span><span class="p">(</span><span class="s1">&#39;redis&#39;</span><span class="p">);</span>
        <span class="nv">$redis</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="nv">$config</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">// https://github.com/camuthig/lumen-custom-db-connection/blob/master/app/Services/Credentials.php
<span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">App\Services</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Predis\ClientInterface</span><span class="p">;</span>

<span class="sd">/**
</span><span class="sd"> * A sample class that pulls credentials from something besides our local configurations.
</span><span class="sd"> *
</span><span class="sd"> * In reality this might be a HTTP call to some other service or pulling it from some encrypted source. The details of
</span><span class="sd"> * that really aren&#39;t important, just that we have to pull these values from somewhere besides the local configurations
</span><span class="sd"> * and the DistributedConfiguration.
</span><span class="sd"> */</span>
<span class="k">class</span> <span class="nc">Credentials</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">get</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$key</span><span class="p">,</span> <span class="nv">$default</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="sd">/** @var ClientInterface $redis */</span>
        <span class="nv">$redis</span> <span class="o">=</span> <span class="nx">app</span><span class="p">(</span><span class="s1">&#39;redis&#39;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$redis</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;secure.&#39;</span> <span class="o">.</span> <span class="nv">$key</span><span class="p">)</span> <span class="o">??</span> <span class="nv">$default</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">set</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$key</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
    <span class="p">{</span>
        <span class="sd">/** @var ClientInterface $redis */</span>
        <span class="nv">$redis</span> <span class="o">=</span> <span class="nx">app</span><span class="p">(</span><span class="s1">&#39;redis&#39;</span><span class="p">);</span>
        <span class="nv">$redis</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;secure.&#39;</span> <span class="o">.</span> <span class="nv">$key</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>With our simple serivces created, the next phase is to define logic allowing us to pull database connection configuration
values from them. The code leverages the work already done in the <code>Illuminate\Database\Connectors\ConnectionFactory</code> class
by extending it and just overriding the <code>parseConfig</code> function. The sample implementation is basic and only supports a <code>pgsql</code>
driver because that is what I was testing against, but the idea could be expanded to work with a more generic structure as
well.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">// https://github.com/camuthig/lumen-custom-db-connection/blob/master/app/Database/CustomConnectionFactory.php
<span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="nx">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="k">namespace</span> <span class="nx">App\Database</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Services\Credentials</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Services\DistributedConfiguration</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Contracts\Container\Container</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Database\Connectors\ConnectionFactory</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CustomConnectionFactory</span> <span class="k">extends</span> <span class="nx">ConnectionFactory</span>
<span class="p">{</span>
    <span class="sd">/**
</span><span class="sd">     * @var DistributedConfiguration
</span><span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$configuration</span><span class="p">;</span>

    <span class="sd">/**
</span><span class="sd">     * @var Credentials
</span><span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$credentials</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nx">Container</span> <span class="nv">$container</span><span class="p">,</span> <span class="nx">DistributedConfiguration</span> <span class="nv">$configuration</span><span class="p">,</span> <span class="nx">Credentials</span> <span class="nv">$credentials</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="nv">$container</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">configuration</span> <span class="o">=</span> <span class="nv">$configuration</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">credentials</span> <span class="o">=</span> <span class="nv">$credentials</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">parseConfig</span><span class="p">(</span><span class="k">array</span> <span class="nv">$config</span><span class="p">,</span> <span class="nv">$name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$name</span><span class="p">,</span>
            <span class="s1">&#39;driver&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;pgsql&#39;</span><span class="p">,</span>
            <span class="s1">&#39;prefix&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">configuration</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;database.prefix&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="s1">&#39;host&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">configuration</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;database.host&#39;</span><span class="p">),</span>
            <span class="s1">&#39;port&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">configuration</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;database.port&#39;</span><span class="p">),</span>
            <span class="s1">&#39;database&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">configuration</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;database.database&#39;</span><span class="p">),</span>
            <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">credentials</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;database.username&#39;</span><span class="p">),</span>
            <span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">credentials</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;database.password&#39;</span><span class="p">),</span>
            <span class="s1">&#39;charset&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">configuration</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;database.charset&#39;</span><span class="p">),</span>
            <span class="s1">&#39;schema&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">configuration</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;database.schema&#39;</span><span class="p">),</span>
        <span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>Next is to extend the <code>DatabaseManager</code> with a custom resolver for our connection, which we will name <code>custom</code>. I chose to
add this to a new service provider, to keep things clean, and then registered the service provider in <code>app.php</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">// https://github.com/camuthig/lumen-custom-db-connection/blob/master/app/Providers/DatabaseConnectionServiceProvider.php
<span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="nx">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="k">namespace</span> <span class="nx">App\Providers</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Database\CustomConnectionFactory</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Carbon\Laravel\ServiceProvider</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Support\Facades\DB</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Laravel\Lumen\Application</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">DatabaseConnectionServiceProvider</span> <span class="k">extends</span> <span class="nx">ServiceProvider</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">boot</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nx">DB</span><span class="o">::</span><span class="na">extend</span><span class="p">(</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="k">array</span> <span class="nv">$config</span><span class="p">,</span> <span class="o">?</span><span class="nx">string</span> <span class="nv">$name</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">app</span><span class="p">(</span><span class="nx">CustomConnectionFactory</span><span class="o">::</span><span class="na">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">make</span><span class="p">(</span><span class="nv">$config</span><span class="p">,</span> <span class="nv">$name</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>Since this is lumen, and it does not include the <code>config</code> directly by default, we will then create the directory and copy the
<code>database.php</code> file into it, adding an empty <code>connections.custom</code> array. This is important because even though we are not
using any values from it, Lumen will expect the array to exist and fail if it does not.</p>

<p>And that is all there is to it. From here, we can
<a href="https://github.com/camuthig/lumen-custom-db-connection/blob/master/routes/web.php#L18-L26">add a basic a basic test route</a>
and verify that we are able to connect to the database and make a query.</p>


		
	</div>

	<div class="pagination">
		<a href="/posts/ktor-social-auth/" class="left arrow">&#8592;</a>
		<a href="/posts/ktor-graphql-server/" class="right arrow">&#8594;</a>

		<a href="#" class="top">Top</a>
	</div>
</main>


        		<footer>
			<span>
			&copy; <time datetime="2021-06-14 17:19:53.717668401 &#43;0000 UTC m=&#43;0.534111186">2021</time> Chris Muthig. Made with <a href='https://gohugo.io'>Hugo</a> using the <a href='https://github.com/EmielH/tale-hugo/'>Tale</a> theme.
			</span>
		</footer>

    </body>
</html>
